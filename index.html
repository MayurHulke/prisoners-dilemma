<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Theory Arcade - Interactive Learning Games</title>
    <meta name="description" content="Learn game theory through interactive games. Play Prisoner's Dilemma, Ultimatum Game, and more. See how your decisions compare to thousands of players.">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H254D05KNP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-H254D05KNP');
    </script>

    <link rel="stylesheet" href="hub-style.css">
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1><span class="emoji-animated">üéÆ</span> Game Theory Arcade</h1>
            <p class="tagline">Learn how humans really make decisions</p>
        </header>

        <!-- Global Statistics Section -->
        <div class="global-stats">
            <h3>üåç What Real Players Do</h3>
            <div class="global-stats-grid">
                <div class="global-stat">
                    <div class="global-stat-value" id="total-players">...</div>
                    <div class="global-stat-label">Total Games Played</div>
                </div>
                <div class="global-stat highlight">
                    <div class="global-stat-value" id="humans-cooperate">...</div>
                    <div class="global-stat-label">Humans cooperate despite game theory predicting 0%</div>
                </div>
                <div class="global-stat">
                    <div class="global-stat-value" id="reject-unfair">...</div>
                    <div class="global-stat-label">Reject unfair offers even when it costs them money</div>
                </div>
                <div class="global-stat">
                    <div class="global-stat-value" id="lakes-die">...</div>
                    <div class="global-stat-label">Of shared resources die from overuse</div>
                </div>
            </div>
            <p class="stats-tagline">Are you more rational than the crowd? Or just as human?</p>
        </div>

        <div class="games-grid">
            <!-- Prisoner's Dilemma Card -->
            <div class="game-card active">
                <div class="game-badge live">Live</div>
                <div class="game-icon">‚öñÔ∏è</div>
                <h2>Prisoner's Dilemma</h2>
                <p class="game-description">Trust or betray? Make tough choices and see how you compare to thousands of real players.</p>

                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-value" id="pd-players">1,247</span>
                        <span class="stat-label">Players</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="pd-coop">52%</span>
                        <span class="stat-label">Cooperation</span>
                    </div>
                </div>

                <div class="game-tags">
                    <span class="tag">Nash Equilibrium</span>
                    <span class="tag">Trust</span>
                    <span class="tag">10 Rounds</span>
                </div>

                <div class="key-insight">
                    <span class="insight-icon">üí°</span>
                    <span class="insight-text" id="pd-insight">Loading insight...</span>
                </div>

                <a href="prisoners-dilemma/" class="btn btn-play">Play Now ‚Üí</a>
            </div>

            <!-- Ultimatum Game Card -->
            <div class="game-card active">
                <div class="game-badge live">Live</div>
                <div class="game-icon">üí∞</div>
                <h2>Ultimatum Game</h2>
                <p class="game-description">Split money with a stranger. How fair will you be? How much unfairness will you tolerate?</p>

                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-value" id="ug-players">...</span>
                        <span class="stat-label">Players</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="ug-avg-offer">...</span>
                        <span class="stat-label">Avg Offer</span>
                    </div>
                </div>

                <div class="game-tags">
                    <span class="tag">Fairness</span>
                    <span class="tag">Behavioral Economics</span>
                    <span class="tag">5 Rounds</span>
                </div>

                <div class="key-insight">
                    <span class="insight-icon">üí°</span>
                    <span class="insight-text" id="ug-insight">Loading insight...</span>
                </div>

                <a href="ultimatum-game/" class="btn btn-play">Play Now ‚Üí</a>
            </div>

            <!-- Tragedy of the Commons Card -->
            <div class="game-card active">
                <div class="game-badge live">Live</div>
                <div class="game-icon">üåç</div>
                <h2>Tragedy of the Commons</h2>
                <p class="game-description">Fish from a shared lake. Will you be sustainable or grab what you can before others do?</p>

                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-value" id="tc-players">...</span>
                        <span class="stat-label">Players</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="tc-survival">...</span>
                        <span class="stat-label">Survival Rate</span>
                    </div>
                </div>

                <div class="game-tags">
                    <span class="tag">Resource Management</span>
                    <span class="tag">Sustainability</span>
                    <span class="tag">10 Rounds</span>
                </div>

                <div class="key-insight">
                    <span class="insight-icon">üí°</span>
                    <span class="insight-text" id="tc-insight">Loading insight...</span>
                </div>

                <a href="tragedy-commons/" class="btn btn-play">Play Now ‚Üí</a>
            </div>

            <!-- Public Goods Game Card -->
            <div class="game-card active">
                <div class="game-badge live">Live</div>
                <div class="game-icon">üèõÔ∏è</div>
                <h2>Public Goods Game</h2>
                <p class="game-description">Contribute to the public fund or free-ride? See why Wikipedia needs donation drives.</p>

                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-value" id="pg-players">...</span>
                        <span class="stat-label">Players</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="pg-avg-contrib">...</span>
                        <span class="stat-label">Avg Contribution</span>
                    </div>
                </div>

                <div class="game-tags">
                    <span class="tag">Free Riding</span>
                    <span class="tag">Public Goods</span>
                    <span class="tag">10 Rounds</span>
                </div>

                <div class="key-insight">
                    <span class="insight-icon">üí°</span>
                    <span class="insight-text" id="pg-insight">Loading insight...</span>
                </div>

                <a href="public-goods/" class="btn btn-play">Play Now ‚Üí</a>
            </div>
        </div>

        <footer class="main-footer">
            <div class="footer-content">
                <h3>About Game Theory Arcade</h3>
                <p>Interactive games that teach game theory concepts through real human behavior. Play, compare your decisions to thousands of others, and discover how humans actually make strategic choices.</p>

                <div class="footer-links">
                    <a href="https://github.com/MayurHulke/game-theory-arcade" target="_blank">GitHub</a>
                    <span>‚Ä¢</span>
                    <a href="https://en.wikipedia.org/wiki/Game_theory" target="_blank">Learn About Game Theory</a>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        // Load live stats for games
        import { firebaseConfig, isFirebaseConfigured } from './shared/firebase-config.js';
        import { safeNumberFormat, safePercentFormat, sanitizeFirebaseData } from './shared/dom-utils.js';

        async function loadStats() {
            if (!isFirebaseConfigured()) {
                // Demo stats - individual games
                document.getElementById('pd-players').textContent = '1,247';
                document.getElementById('pd-coop').textContent = '52%';
                document.getElementById('ug-players').textContent = '823';
                document.getElementById('ug-avg-offer').textContent = '$4.20';
                document.getElementById('tc-players').textContent = '1,584';
                document.getElementById('tc-survival').textContent = '42%';
                document.getElementById('pg-players').textContent = '2,341';
                document.getElementById('pg-avg-contrib').textContent = '$4.20';

                // Demo stats - global
                document.getElementById('total-players').textContent = '5,595';
                document.getElementById('humans-cooperate').textContent = '52%';
                document.getElementById('reject-unfair').textContent = '32%';
                document.getElementById('lakes-die').textContent = '58%';

                // Demo insights
                document.getElementById('pd-insight').textContent = 'Most players cooperate first, then switch to tit-for-tat';
                document.getElementById('ug-insight').textContent = 'Average offer is $4.20 - way above theory\'s prediction of $0.01!';
                document.getElementById('tc-insight').textContent = '58% of lakes die - tragedy strikes even with warnings';
                document.getElementById('pg-insight').textContent = 'Players contribute $4.50 on average (theory predicts $0)';
                return;
            }

            try {
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getDatabase, ref, get } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');

                const app = initializeApp(firebaseConfig);
                const db = getDatabase(app);

                // Load Prisoner's Dilemma stats
                const gamesSnapshot = await get(ref(db, 'games'));
                if (gamesSnapshot.exists()) {
                    const games = Object.values(gamesSnapshot.val());
                    const playerCount = Math.min(games.length, 999999); // Cap at reasonable number
                    document.getElementById('pd-players').textContent = playerCount.toLocaleString();

                    // Calculate average cooperation (sanitize each value)
                    const validRates = games.map(g => sanitizeFirebaseData(g.cooperationRate || 0, 'number'));
                    const avgCoop = validRates.reduce((sum, rate) => sum + rate, 0) / validRates.length;
                    document.getElementById('pd-coop').textContent = safePercentFormat(avgCoop);
                }

                // Load Ultimatum Game stats
                const ugGamesSnapshot = await get(ref(db, 'ultimatum-games'));
                if (ugGamesSnapshot.exists()) {
                    const ugGames = Object.values(ugGamesSnapshot.val());
                    const playerCount = Math.min(ugGames.length, 999999);
                    document.getElementById('ug-players').textContent = playerCount.toLocaleString();

                    // Calculate average offer (sanitize each value)
                    const validOffers = ugGames.map(g => sanitizeFirebaseData(g.averageOffer || 0, 'number'));
                    const avgOffer = validOffers.reduce((sum, offer) => sum + offer, 0) / validOffers.length;
                    document.getElementById('ug-avg-offer').textContent = `$${safeNumberFormat(avgOffer, 2)}`;
                } else {
                    document.getElementById('ug-players').textContent = '0';
                    document.getElementById('ug-avg-offer').textContent = '$0.00';
                }

                // Load Tragedy of the Commons stats
                const tcGamesSnapshot = await get(ref(db, 'tragedy-games'));
                if (tcGamesSnapshot.exists()) {
                    const tcGames = Object.values(tcGamesSnapshot.val());
                    const playerCount = Math.min(tcGames.length, 999999);
                    document.getElementById('tc-players').textContent = playerCount.toLocaleString();

                    // Calculate survival rate (sanitize boolean values)
                    const survived = tcGames.filter(g => !sanitizeFirebaseData(g.lakeDied, 'boolean')).length;
                    const survivalRate = (survived / tcGames.length) * 100;
                    document.getElementById('tc-survival').textContent = safePercentFormat(survivalRate);
                } else {
                    document.getElementById('tc-players').textContent = '0';
                    document.getElementById('tc-survival').textContent = '0%';
                }

                // Load Public Goods Game stats
                const pgGamesSnapshot = await get(ref(db, 'public-goods-games'));
                let pgGames = [];
                if (pgGamesSnapshot.exists()) {
                    pgGames = Object.values(pgGamesSnapshot.val());
                    const playerCount = Math.min(pgGames.length, 999999);
                    document.getElementById('pg-players').textContent = playerCount.toLocaleString();

                    // Calculate average contribution (sanitize each value)
                    const validContribs = pgGames.map(g => sanitizeFirebaseData(g.avgContribution || 0, 'number'));
                    const avgContrib = validContribs.reduce((sum, c) => sum + c, 0) / validContribs.length;
                    document.getElementById('pg-avg-contrib').textContent = `$${safeNumberFormat(avgContrib, 2)}`;
                } else {
                    document.getElementById('pg-players').textContent = '0';
                    document.getElementById('pg-avg-contrib').textContent = '$0.00';
                }

                // Calculate and display global statistics
                const games = gamesSnapshot.exists() ? Object.values(gamesSnapshot.val()) : [];
                const ugGames = ugGamesSnapshot.exists() ? Object.values(ugGamesSnapshot.val()) : [];
                const tcGames = tcGamesSnapshot.exists() ? Object.values(tcGamesSnapshot.val()) : [];

                // Total games played
                const totalGames = games.length + ugGames.length + tcGames.length + pgGames.length;
                document.getElementById('total-players').textContent = totalGames.toLocaleString();

                // Humans cooperate rate
                if (games.length > 0) {
                    const validRates = games.map(g => sanitizeFirebaseData(g.cooperationRate || 0, 'number'));
                    const avgCoop = validRates.reduce((sum, rate) => sum + rate, 0) / validRates.length;
                    document.getElementById('humans-cooperate').textContent = safePercentFormat(avgCoop);
                }

                // Reject unfair offers (estimate based on avg offer)
                if (ugGames.length > 0) {
                    const validOffers = ugGames.map(g => sanitizeFirebaseData(g.averageOffer || 0, 'number'));
                    const lowOffers = validOffers.filter(offer => offer < 3).length;
                    const rejectRate = (lowOffers / validOffers.length) * 100;
                    document.getElementById('reject-unfair').textContent = safePercentFormat(rejectRate);
                }

                // Lakes die rate
                if (tcGames.length > 0) {
                    const died = tcGames.filter(g => sanitizeFirebaseData(g.lakeDied, 'boolean')).length;
                    const diedRate = (died / tcGames.length) * 100;
                    document.getElementById('lakes-die').textContent = safePercentFormat(diedRate);
                }

                // Generate dynamic insights for each game
                if (games.length > 0) {
                    const validRates = games.map(g => sanitizeFirebaseData(g.cooperationRate || 0, 'number'));
                    const avgCoop = validRates.reduce((sum, rate) => sum + rate, 0) / validRates.length;
                    const coopPercent = Math.round(avgCoop);
                    document.getElementById('pd-insight').textContent = `${coopPercent}% cooperation rate - humans defy game theory's 0% prediction!`;
                }

                if (ugGames.length > 0) {
                    const validOffers = ugGames.map(g => sanitizeFirebaseData(g.averageOffer || 0, 'number'));
                    const avgOffer = validOffers.reduce((sum, offer) => sum + offer, 0) / validOffers.length;
                    document.getElementById('ug-insight').textContent = `Average offer: $${avgOffer.toFixed(2)} - way above theory's $0.01 prediction!`;
                }

                if (tcGames.length > 0) {
                    const died = tcGames.filter(g => sanitizeFirebaseData(g.lakeDied, 'boolean')).length;
                    const diedRate = Math.round((died / tcGames.length) * 100);
                    document.getElementById('tc-insight').textContent = `${diedRate}% of lakes die from overfishing - the tragedy strikes!`;
                }

                if (pgGames.length > 0) {
                    const validContribs = pgGames.map(g => sanitizeFirebaseData(g.avgContribution || 0, 'number'));
                    const avgContrib = validContribs.reduce((sum, c) => sum + c, 0) / validContribs.length;
                    document.getElementById('pg-insight').textContent = `Average contribution: $${avgContrib.toFixed(2)} (theory predicts $0!)`;
                }

            } catch (error) {
                console.log('Using demo stats');
            }
        }

        loadStats();
    </script>
</body>
</html>
